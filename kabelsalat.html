<!doctype html>
<html lang="en">
  <body>
    <script type="module">
      import { SalatRepl } from '@kabelsalat/web';
      const kabelsalat = new SalatRepl();
      function send(type, msg) {
        window.parent.postMessage({ type, msg });
      }
      window.parent.kabelsalat = kabelsalat;

      window.kabelgate = (id) => cc(`kabelgate-${id}`);
      window.kabeltrig = (id) => kabelgate(id).trig();
      window.kabelvalue = (id) => cc(`kabelvalue-${id}`);

      console.log('[kabelsalat] waiting for document click to init');
      window.parent.document.addEventListener('click', async function interaction() {
        window.parent.document.removeEventListener('click', interaction);
        try {
          console.log('init ks', import.meta.url);
          // http://localhost:5173/node_modules/.vite/deps/assets/worklet-B8fb_TPB.js
          // without base:
          // http://localhost:5173/assets/worklet-DzGFm3ry.js

          await kabelsalat.audio.init();
          console.log('[kabelsalat] audio init done');
        } catch (err) {
          console.error(`could not init kabelsalat: ${err.message}`);
          console.dir(err);
        }
      });

      function getDoubleQuotedStringLocations(code) {
        const regex = /"([^"\\]*(\\.[^"\\]*)*)"/g;
        const locations = [];
        let match;
        while ((match = regex.exec(code)) !== null) {
          const start = match.index + 1;
          const end = regex.lastIndex - 1;
          locations.push([start, end]);
        }
        return locations;
      }

      window.addEventListener('message', (event) => {
        if (event.origin !== window.location.origin) {
          return;
        }
        // console.log("received", event.data);
        if (event.data.type === 'eval') {
          // console.log('eval', event.data.msg);
          const { body: code, docId } = event.data.msg;
          try {
            let patterns = [];
            // TODO: set loc automatically from transpiler
            window.P = (pattern, loc) => {
              if (!window.parent.strudel) return;
              const valueID = `minivalue-${patterns.length}`;
              const gateID = `minigate-${patterns.length}`;
              const reified = window.parent.strudelWindow.m(pattern, loc).onTrigger((_, hap, ct, cps, t) => {
                const onset = t - ct;
                const offset = onset + hap.duration / cps - 0.05;
                parent.kabelsalat.audio.setControls([
                  { id: gateID, time: onset, value: 1 },
                  { id: gateID, time: offset, value: 0 },
                  { id: valueID, time: onset, value: hap.value.value },
                ]);
              });
              patterns.push(reified);
              const value = cc(valueID),
                gate = cc(gateID),
                trig = gate.trig();
              return { value, gate };
            };

            kabelsalat.run(code);

            if (window.parent.strudelWindow && patterns.length) {
              // TODO: make this less ugly
              const doubleQuotedStringLocations = getDoubleQuotedStringLocations(code);
              let miniLocations = [];
              doubleQuotedStringLocations.forEach((loc) => {
                const part = code.slice(...loc);
                const atoms = window.parent.strudelWindow.getLeafLocations(`"${part}"`);
                atoms.forEach((atom) => {
                  const [begin, end] = atom;
                  miniLocations.push([loc[0] + begin - 1, loc[0] + end - 1]);
                });
              });
              // dummy comment
              window.parent.strudel.onUpdateMiniLocations(docId, miniLocations);
              // uglyness ends here
              const docPattern = window.parent.strudelWindow.stack(...patterns);
              window.parent.strudel.setDocPattern(docId, docPattern);
            }
          } catch (err) {
            send('onError', [`kabelsalat error: ${err.message}`, docId]);
          }
        }
      });
      console.log('kabelsalat iframe loaded', kabelsalat);
    </script>
  </body>
</html>
