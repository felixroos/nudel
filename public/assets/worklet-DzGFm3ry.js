(function(){"use strict";function c(n,t){if(t||(t="assertion failed"),!n)throw new Error(t)}function d(n,t,s){return n<=0?t:n>=1?s:t+n*(s-t)}function O(n,t,s){return n<=t?0:n>=s?1:s===t?0:(n-t)/(s-t)}function M(n,t){return n<t?(n/=t,n+n-n*n-1):n>1-t?(n=(n-1)/t,n*n+n+n+1):0}function v(n,t){t=Math.min(Math.max(t,0),1),t-=.01;var s=2*t/(1-t),e=(1+s)*n/(1+s*Math.abs(n));return e}function p(n,t,s){return n>=1?s:t+n*(s-t)}function C(){this.state="off",this.startTime=0,this.startVal=0}C.prototype.eval=function(n,t,s,e,i,r){switch(this.state){case"off":return t>0&&(this.state="attack",this.startTime=n,this.startVal=0),0;case"attack":{let h=n-this.startTime;return h>s?(this.state="decay",this.startTime=n,1):p(h/s,this.startVal,1)}case"decay":{let h=n-this.startTime,a=p(h/e,1,i);return t<=0?(this.state="release",this.startTime=n,this.startVal=a,a):h>e?(this.state="sustain",this.startTime=n,i):a}case"sustain":return t<=0&&(this.state="release",this.startTime=n,this.startVal=i),i;case"release":{let h=n-this.startTime;if(h>r)return this.state="off",0;let a=p(h/r,this.startVal,0);return t>0&&(this.state="attack",this.startTime=n,this.startVal=a),a}}throw"invalid envelope state"};function f(){this.s0=0,this.s1=0}f.prototype.apply=function(n,t,s){c(!isNaN(n),"NaN value fed in TwoPoleFilter"),t=Math.min(t,1),s=Math.max(s,0);var e=Math.pow(.5,(1-t)/.125),i=Math.pow(.5,(s+.125)/.125),r=1-i*e,h=this.s0,a=this.s1;return h=r*h-e*a+e*n,a=r*a+e*h,n=a,this.s0=h,this.s1=a,n};let P=class y{constructor(t,s){this.sampleRate=t,s?this.buffer=s.slice(0):(this.buffer=new Float32Array(10*t),this.buffer.fill(0)),this.writeIdx=0,this.readIdx=0}reset(){this.buffer.fill(0),this.writeIdx=0,this.readIdx=0}clone(){const t=new y(this.sampleRate,this.buffer);return t.writeIdx=this.writeIdx,t.readIdx=this.readIdx,t}write(t,s){this.writeIdx=(this.writeIdx+1)%this.buffer.length,this.buffer[this.writeIdx]=t;let e=Math.min(Math.floor(this.sampleRate*s),this.buffer.length-1);this.readIdx=this.writeIdx-e,this.readIdx<0&&(this.readIdx+=this.buffer.length)}read(){return this.buffer[this.readIdx]}};const g=1/44100,m=24,x=m/4;class u{constructor(t,s,e,i){this.nodeId=t,this.state=s,this.sampleRate=e,this.sampleTime=1/e,this.send=i}setState(t){this.state=t}}class T extends u{constructor(t,s,e,i){super(t,s,e,i),this.env=new C}update(t,s,e,i,r,h){return this.env.eval(t,s,e,i,r,h)}}class I extends u{constructor(t,s,e,i){super(t,s,e,i),this.phase=0}update(t){let s=m*t/60,e=.5;return this.phase+=this.sampleTime*s,this.phase%1<e?1:-1}}class k extends u{constructor(t,s,e,i){super(t,s,e,i),this.inSgn=!0,this.outSgn=!0,this.clockCnt=0}update(t,s){let e=t>0;return this.inSgn!=e&&(this.clockCnt++,this.clockCnt>=s&&(this.clockCnt=0,this.outSgn=!this.outSgn)),this.inSgn=e,this.outSgn?1:-1}}class E extends u{constructor(t,s,e,i){super(t,s,e,i),this.inSgn=!1}update(t,s){let e=s>0;return e&&this.inSgn!=e&&this.send({type:"CLOCK_PULSE",nodeId:this.nodeId,time:t}),this.inSgn=e,0}}const S=new Map;class N extends u{constructor(t,s,e,i){super(t,s,e,i);const r=s.inputs[2];r&&S.has(r)?this.delay=S.get(r).clone():this.delay=new P(e),r&&S.set(r,this.delay)}update(t,s){return this.delay.write(t,s),this.delay.read()}}class q extends u{constructor(t,s,e,i){super(t,s,e,i)}update(t,s){return v(t,s)}}class L extends u{constructor(t,s,e,i){super(t,s,e,i),this.value=0,this.trigSgn=!1}write(t,s){!this.trigSgn&&s>0&&(this.value=t),this.trigSgn=s>0}read(){return this.value}update(t,s){return this.write(t,s),this.read()}}class D{constructor(){this.value=0}update(t){return this.value=t,this.value}}class _{update(){return Math.random()*2-1}}class A{update(t){return Math.random()<t*g?Math.random():0}}class F{constructor(){this.out=0}update(){let t=Math.random()*2-1;return this.out=(this.out+.02*t)/1.02,this.out}}class G{constructor(){this.b0=0,this.b1=0,this.b2=0,this.b3=0,this.b4=0,this.b5=0,this.b6=0}update(){const t=Math.random()*2-1;this.b0=.99886*this.b0+t*.0555179,this.b1=.99332*this.b1+t*.0750759,this.b2=.969*this.b2+t*.153852,this.b3=.8665*this.b3+t*.3104856,this.b4=.55*this.b4+t*.5329522,this.b5=-.7616*this.b5-t*.016898;const s=this.b0+this.b1+this.b2+this.b3+this.b4+this.b5+this.b6+t*.5362;return this.b6=t*.115926,s*.11}}class R extends u{constructor(t,s,e,i){super(t,s,e,i),this.phase=1}update(t){this.phase+=this.sampleTime*t;let s=this.phase>=1?1:0;return this.phase=this.phase%1,s}}class U extends u{constructor(t,s,e,i){super(t,s,e,i),this.phase=0}update(t,s){return this.phase+=this.sampleTime*t,this.phase%1<s?1:-1}}class V extends u{constructor(t,s,e,i){super(t,s,e,i),this.phase=0}update(t){return this.phase+=this.sampleTime*t,this.phase%1*2-1}}class B{constructor(){this.phase=Math.random()}update(t){const s=t/sampleRate;let e=M(this.phase,s),i=2*this.phase-1-e;return this.phase+=s,this.phase>1&&(this.phase-=1),i}}class $ extends u{constructor(t,s,e,i){super(t,s,e,i),this.phase=0,this.syncSgn=!1}update(t,s,e){!this.syncSgn&&s>0&&(this.phase=0),this.syncSgn=s>0;let i=(this.phase+e)%1;return this.phase+=this.sampleTime*t,Math.sin(i*2*Math.PI)}}class K{dBToLinear(t){return Math.pow(10,t/20)}linearToDB(t){return 20*Math.log10(t)}update(t,s,e){let i=this.linearToDB(Math.abs(t)),r=0;return i>s&&(r=(i-s)*(1-1/e)),this.dBToLinear(-r)}}class H extends u{constructor(t,s,e,i){super(t,s,e,i),this.phase=0}update(t){this.phase+=this.sampleTime*t;let s=this.phase%1;return(s<.5?2*s:1-2*(s-.5))*2-1}}class W{constructor(){this.lagUnit=4410,this.s=0}update(t,s){return s=s*this.lagUnit,s<1&&(s=1),this.s+=1/s*(t-this.s),this.s}}class j{constructor(){this.last=0}update(t,s,e){const i=s*g,r=e*g;let h=t-this.last;return h>i?h=i:h<-r&&(h=-r),this.last+=h,this.last}}class Q extends u{constructor(t,s,e,i){super(t,s,e,i),this.s=0}update(t,s){return s=s*1e3,s<1&&(s=1),this.s+=1/s*(t-this.s),this.s}}class X extends u{constructor(t,s,e,i){super(t,s,e,i),this.filter=new f}update(t,s,e){return this.filter.apply(t,s,e),this.filter.s1}}class Y extends u{constructor(t,s,e,i){super(t,s,e,i),this.filter=new f}update(t,s,e){return this.filter.apply(t,s,e),this.filter.s0}}class Z extends u{constructor(t,s,e,i){super(t,s,e,i)}update(t,s){return s<0&&(s=0),s=s+1,t=t*s,4*(Math.abs(.25*t+.25-Math.round(.25*t+.25))-.25)}}class z extends u{update(t){return t}}class w extends u{constructor(t,s,e,i){super(t,s,e,i),this.note=0,this.freq=0,this.gateState="off",this.type="midiin",this.channel=-1}isFree(){return this.gateState==="off"}noteOn(t,s){s>0?(this.note=t,this.freq=2**((t-69)/12)*440,this.gateState="pretrig"):this.noteOff()}noteOff(){this.note=0,this.gateState="off"}getGate(){switch(this.gateState){case"pretrig":return this.gateState="on",0;case"on":return 1;case"off":return 0;default:c(!1)}}getFreq(){switch(this.gateState){case"pretrig":return this.gateState="on",0;case"on":return this.freq;case"off":return this.freq;default:c(!1)}}}class J extends w{constructor(t,s,e,i){super(t,s,e,i),this.type="midigate"}update(t){return this.channel=t,this.getGate()}}class tt extends w{constructor(t,s,e,i){super(t,s,e,i),this.type="midifreq"}update(t){return this.channel=t,this.getFreq()}}class st{constructor(t,s,e,i){this.up=!1,this.send=i,this.value=0,this.type="cc"}setValue(t){this.value=t}update(t,s,e){return this.id=s,!this.up&&t>0?(this.up=!0,this.send({type:"SIGNAL_TRIGGER",id:s,time:e}),this.value):(this.up=t>0,this.value)}}class et extends u{constructor(t,s,e,i){super(t,s,e,i),this.type="cc",this.value=s.inputs[1]??0}setValue(t){this.value=t}update(t){return this.id=t,this.value}}class it extends u{constructor(t,s,e,i){super(t,s,e,i),this.type="midicc",this.value=-1,this.channel=-1,this.ccnumber=-1}setValue(t){this.value=t}update(t,s){return this.ccnumber=t,this.channel=s,this.value}}class nt extends u{constructor(t,s,e,i){super(t,s,e,i),this.clockSgn=!0,this.step=0,this.first=!0}update(t,...s){return!this.clockSgn&&t>0?(this.step=(this.step+1)%s.length,this.clockSgn=t>0,0):(this.clockSgn=t>0,s[this.step])}}class rt extends u{update(t,...s){return s[Math.floor(t)%s.length]}}class ht{update(t,s,e,i,r){let h=O(t,s,e);return d(h,i,r)}}class at{update(t,s,e){return Math.min(Math.max(t,s),e)}}class ut{constructor(){this.hi=!1}update(t){return!this.hi&&t>0?(this.hi=!0,1):(this.hi&&t<=0&&(this.hi=!1),0)}}var lt=Object.freeze({__proto__:null,ADSRNode:T,AudioIn:z,AudioNode:u,BPF:Y,BrownNoiseOsc:F,CC:et,CLOCK_PPQ:m,CLOCK_PPS:x,Clip:at,Clock:I,ClockDiv:k,ClockOut:E,Delay:N,Distort:q,DustOsc:A,Filter:X,Fold:Z,Hold:L,ImpulseOsc:R,Lag:W,MidiCC:it,MidiFreq:tt,MidiGate:J,MidiIn:w,NoiseOsc:_,Output:D,Pick:rt,PinkNoise:G,PulseOsc:U,Remap:ht,SawOsc:B,Sequence:nt,SidechainCompressor:K,Signal:st,SineOsc:$,Slew:j,Slide:Q,TriOsc:H,Trig:ut,ZawOsc:V});const b=new Map(Object.entries(lt));class ot{constructor(t,s){c(t==44100),this.sampleRate=t,this.playPos=0,this.send=s,this.units=[],this.fadeTime=.1,this.q=[]}fadeOutLastUnit(){this.units.length&&this.units[this.units.length-1].fadeOut(this.playPos,this.fadeTime)}stop(){this.fadeOutLastUnit(),this.send({type:"STOP",fadeTime:this.fadeTime})}newUnit(t){const s=new ct(t,this.sampleRate,this.send);this.fadeOutLastUnit(),s.fadeIn(this.playPos,this.fadeTime),this.units=this.units.filter(e=>e.getLevel(this.playPos)>0),this.units.push(s),console.log(`${t.ugens.length} ugens spawned, ${this.units.length} units alive`)}parseMsg(t){switch(t.type){case"NEW_UNIT":this.newUnit(t.unit);break;case"NOTE_ON":this.noteOn(t);break;case"CC":this.midiCC(t);break;case"SET_CONTROL":this.setControl(t);break;case"FADE_TIME":this.fadeTime=Number(t.fadeTime);break;case"STOP":this.stop();break;case"SET_UGEN":this.addUgen(t.className,t.ugen);break;case"SCHEDULE_MSG":this.scheduleMessage(t);break;case"BATCH_MSG":t.messages.forEach(s=>this.parseMsg(s));break;default:throw new TypeError(`unknown message type ${t.type}`)}}noteOn(t){this.units.forEach(s=>s.noteOn(t))}midiCC(t){this.units.forEach(s=>s.midiCC(t))}setControl(t){this.units.forEach(s=>s.setControl(t))}scheduleMessage(t){if(t.time=this.playPos+t.time,!this.q.length){this.q.push(t);return}let s=0;for(;s<this.q.length&&this.q[s].time<t.time;)s++;this.q.splice(s,0,t)}genSample(t){for(;this.q.length>0&&this.q[0].time<=this.playPos;)this.parseMsg(this.q[0].msg),this.q.shift();if(!this.units.length)return[0,0];const s=[0,0];for(let e=0;e<this.units.length;e++){const i=this.units[e],r=i.getLevel(this.playPos);i.genSample(this.playPos,i.nodes,t,i.registers,i.outputs,i.sources),s[0]+=i.outputs[0]*r,s[1]+=i.outputs[1]*r}return this.playPos+=1/44100,s}addUgen(t,s){const e=new Function(`${s};return ${t}`)();b.set(t,e)}}class ct{constructor(t,s,e){this.sampleRate=s,this.send=e,this.nodes=[];for(let r in t.ugens){const h=t.ugens[r];if(b.has(h.type)){const a=b.get(h.type),l=Number(r);this.nodes[l]=new a(l,h,this.sampleRate,this.send)}else console.warn(`unknown ugen "${h.type}"`)}this.registers=new Array(t.registers).fill(0);let i=16;this.outputs=new Array(i).fill(0),this.sources=new Array(i).fill(0),t.src=`o.fill(0); // reset outputs
`+t.src,this.genSample=new Function("time","nodes","input","r","o","s",t.src)}noteOn(t){const{channel:s,note:e,velocity:i}=t,r=this.nodes.filter(a=>a.type==="midifreq"&&(a.channel===-1||a.channel===s)),h=this.nodes.filter(a=>a.type==="midigate"&&(a.channel===-1||a.channel===s));if(i>0){let a=r.find(o=>o.isFree())||r[0],l=h.find(o=>o.isFree())||h[0];a?.noteOn(e,i),l?.noteOn(e,i)}else r.find(a=>a.note===e)?.noteOff(),h.find(a=>a.note===e)?.noteOff()}midiCC(t){const{channel:s,cc:e,value:i}=t;this.nodes.forEach(r=>{r.type==="midicc"&&(r.channel===-1||r.channel===s)&&r.ccnumber===e&&r.setValue(i)})}setControl(t){const{value:s,id:e}=t,i=this.nodes.find(r=>r.type==="cc"&&r.id===e);i&&i.setValue(s)}fadeIn(t,s){const e=t,i=t+s;this.getLevel=r=>d((r-e)/(i-e),0,.3)}fadeOut(t,s){const e=t,i=t+s,r=this.getLevel(t);this.getLevel=h=>d((h-e)/(i-e),r,0)}}class dt extends AudioWorkletProcessor{constructor(){super(),this.port.onmessage=this.onmessage.bind(this),this.audioGraph=new ot(44100,this.port.postMessage.bind(this.port))}onmessage(t){let s=t.data;this.audioGraph.parseMsg(s)}process(t,s,e){const i=s[0],r=t[0][0],h=i[0],a=i[1];for(let l=0;l<h.length;l++){let[o,pt]=this.audioGraph.genSample(r?r[l]:0);h[l]=o,a[l]=pt}return!0}}registerProcessor("sample-generator",dt)})();
